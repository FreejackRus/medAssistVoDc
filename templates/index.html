<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <title>ИИ-ассистент эксперта</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Marked + Highlight -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <style>
    /* базовые стили Markdown */
    #result h1, #result h2, #result h3, #result h4 { @apply text-sky-700 font-bold mt-5 mb-2; }
    #result ul { @apply list-disc list-inside text-slate-800; }
    #result ol { @apply list-decimal list-inside text-slate-800; }
    #result pre { @apply bg-slate-50 border border-slate-200 p-3 rounded-md overflow-x-auto my-3; }
    #result code { @apply bg-slate-200 px-1.5 py-0.5 rounded text-sm text-rose-600; }
    #result blockquote { @apply border-l-4 border-sky-400 pl-4 italic text-slate-600; }
  </style>
</head>
<body class="bg-slate-100 font-['Inter']">

<!-- контейнер по центру -->
<div class="max-w-3xl mx-auto py-12 px-4">

  <!-- шапка -->
  <div class="text-center mb-10">
    <h1 class="text-5xl font-bold text-slate-900 mb-4">ИИ-ассистент эксперта</h1>
    <p class="text-slate-600 text-lg">
      Загрузите клиническую рекомендацию (PDF) и получите структурированный алгоритм в формате Markdown.
    </p>
  </div>

  <!-- кнопка загрузки -->
  <form id="uploadForm" class="text-center mb-8">
    <label class="inline-block cursor-pointer">
      <input type="file" name="pdf" accept=".pdf" required class="hidden">
      <span class="bg-sky-600 hover:bg-sky-700 text-white font-semibold px-6 py-3 rounded-lg shadow-md transition">
        Выбрать PDF
      </span>
    </label>
  </form>

  <!-- область вывода -->
  <div id="result"
       class="prose prose-slate max-w-none border border-slate-300 rounded-xl bg-white p-6 shadow-lg max-h-[65vh] overflow-y-auto hidden">
  </div>

</div>

<script>
const form   = document.getElementById('uploadForm');
const input  = form.querySelector('input[type=file]');
const result = document.getElementById('result');

// настройки Marked
marked.setOptions({
  breaks: true,
  highlight: function(code, lang) {
    const language = hljs.getLanguage(lang) ? lang : 'plaintext';
    return hljs.highlight(code, { language }).value;
  }
});

// обработка загрузки
form.addEventListener('change', async e => {
  const file = input.files[0];
  if (!file) return;

  result.textContent = '';
  result.classList.remove('hidden');

  const body = new FormData();
  body.append('pdf', file);

  const res = await fetch('/generate', { method: 'POST', body });
  const reader = res.body.getReader();
  const dec = new TextDecoder('utf-8');
  let buffer = '';

  while (true) {
    const {done, value} = await reader.read();
    if (done) break;
    const lines = dec.decode(value).split('\n\n');
    for (const l of lines) {
      if (l.startsWith('data:')) {
        const txt = JSON.parse(l.slice(6));
        buffer += txt;
        result.innerHTML = marked.parse(buffer);
        // подсветка кода
        document.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));
        result.scrollTop = result.scrollHeight;
      }
    }
  }
});
</script>
</body>
</html>