<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <title>ИИ-ассистент эксперта</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Inter', sans-serif; background: #f1f5f9; }
    #result h2 {
      @apply text-sky-700 font-semibold border-l-4 border-sky-400 pl-3 my-4;
    }
    #result table {
      @apply w-full border-collapse my-4;
    }
    #result th, #result td {
      @apply border border-slate-300 px-4 py-2;
    }
    #result th {
      @apply bg-slate-100 font-medium;
    }
    #result tr:nth-child(even) {
      @apply bg-slate-50;
    }
    #result pre {
      @apply bg-slate-100 p-3 rounded-md overflow-x-auto my-2;
    }
  </style>
</head>
<body class="bg-slate-100 font-['Inter']">
<div class="max-w-4xl mx-auto py-12 px-4">
  <div class="text-center mb-10">
    <h1 class="text-5xl font-bold text-slate-900 mb-4">ИИ-ассистент эксперта</h1>
    <p class="text-slate-600 text-lg">
      Загрузите PDF и получите структурированный алгоритм.
    </p>
  </div>

  <div class="flex justify-center items-center gap-4 mb-8">
    <form id="uploadForm">
      <label>
        <input type="file" name="pdf" accept=".pdf" required class="hidden"/>
        <span class="bg-sky-600 hover:bg-sky-700 text-white font-semibold px-6 py-3 rounded-lg shadow cursor-pointer">
          Выбрать PDF
        </span>
      </label>
    </form>
    <button id="downloadBtn"
            class="hidden bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-6 py-3 rounded-lg shadow">
      Скачать PDF
    </button>
  </div>

  <div id="result"
       class="border border-slate-300 rounded-xl bg-white p-6 shadow-lg max-h-[65vh] overflow-y-auto hidden">
  </div>
</div>

<script>
  const form = document.getElementById('uploadForm');
  const input = form.querySelector('input[type="file"]');
  const result = document.getElementById('result');
  const dBtn = document.getElementById('downloadBtn');

  let sections = []; // Структурированные данные
  let currentSection = null;

  form.addEventListener('change', async () => {
    const file = input.files[0];
    if (!file) return;

    result.innerHTML = '<p class="text-slate-600">Обработка...</p>';
    result.classList.remove('hidden');
    dBtn.classList.add('hidden');
    sections = [];
    currentSection = null;

    const formData = new FormData();
    formData.append('pdf', file);

    try {
      const res = await fetch('/generate', { method: 'POST', body: formData });
      const reader = res.body.getReader();
      const decoder = new TextDecoder();

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        const chunk = decoder.decode(value);
        const lines = chunk.split('\n\n');
        for (const line of lines) {
          if (line.startsWith('data:')) {
            try {
              const data = JSON.parse(line.slice(5));
              if (data.type === 'text') {
                // Здесь вы можете парсить текст и выделять разделы
                // Пример: если строка начинается с "I.", "II.", "###", и т.д.
                if (data.content.trim().startsWith("**") && data.content.includes("** |")) {
                  // Это таблица — можно вставить как есть
                  result.innerHTML += `<div>${data.content}</div>`;
                } else if (data.content.trim().match(/^[IVX]+\./)) {
                  // Новый раздел
                  currentSection = { title: data.content.trim(), content: "" };
                  sections.push(currentSection);
                  result.innerHTML += `<h2>${data.content}</h2>`;
                } else {
                  // Контент
                  if (currentSection) {
                    currentSection.content += data.content + "\n";
                  }
                  result.innerHTML += `<p>${data.content}</p>`;
                }
              } else if (data.type === 'error') {
                result.innerHTML = `<p class="text-red-600">${data.content}</p>`;
              }
            } catch (e) {
              console.error(e);
            }
          }
        }
      }

      dBtn.classList.remove('hidden');
    } catch (error) {
      result.innerHTML = `<p class="text-red-600">Ошибка: ${error.message}</p>`;
    }
  });

  dBtn.addEventListener('click', async () => {
    const res = await fetch('/download_pdf', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ sections })
    });
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'рекомендации.pdf';
    a.click();
    URL.revokeObjectURL(url);
  });
</script>
</body>
</html>