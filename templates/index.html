<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <title>ИИ-ассистент эксперта</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{background:#f1f5f9;font-family:Inter,Arial,Helvetica,sans-serif;}
  </style>
</head>
<body class="bg-slate-100 font-['Inter']">

<div class="max-w-6xl mx-auto py-12 px-4">
  <div class="text-center mb-10">
    <h1 class="text-5xl font-bold text-slate-900 mb-4">ИИ-ассистент эксперта</h1>
    <p class="text-slate-600 text-lg">
      Загрузите клиническую рекомендацию (PDF) и получите структурированную таблицу.
    </p>
  </div>

  <div class="flex justify-center items-center gap-4 mb-8">
    <form id="uploadForm">
      <label>
        <input type="file" name="pdf" accept=".pdf" required class="hidden">
        <span class="bg-sky-600 hover:bg-sky-700 text-white font-semibold px-6 py-3 rounded-lg shadow cursor-pointer">
          Выбрать PDF
        </span>
      </label>
    </form>
    <button id="downloadBtn"
            class="hidden ml-4 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold px-6 py-3 rounded-lg shadow">
      Скачать PDF
    </button>
  </div>

  <!-- контейнер таблицы -->
  <div id="tableWrapper"
       class="overflow-x-auto hidden">
    <table class="min-w-full bg-white border border-slate-300 rounded-lg shadow">
      <thead id="tableHead" class="bg-slate-100">
        <!-- заголовки -->
      </thead>
      <tbody id="tableBody">
        <!-- строки -->
      </tbody>
    </table>
  </div>
</div>

<script>
let tableData = []; // кеш для PDF

const form   = document.getElementById('uploadForm');
const input  = form.querySelector('input[type=file]');
const dBtn   = document.getElementById('downloadBtn');
const wrap   = document.getElementById('tableWrapper');
const head   = document.getElementById('tableHead');
const body   = document.getElementById('tableBody');

form.addEventListener('change', async () => {
  const file = input.files[0];
  if (!file) return;

  tableData = [];
  head.innerHTML = '';
  body.innerHTML = '';
  wrap.classList.remove('hidden');
  dBtn.classList.add('hidden');

  const fd = new FormData();
  fd.append('pdf', file);

  const res = await fetch('/generate_table', {method:'POST', body:fd});
  const reader = res.body.getReader();
  const dec = new TextDecoder();

  while (true) {
    const {done, value} = await reader.read();
    if (done) break;
    const lines = dec.decode(value).split('\n\n');
    for (const l of lines) {
      if (l.startsWith('data:')) {
        const msg = JSON.parse(l.slice(6));
        if (msg.error) { alert(msg.error); return; }
        if (msg.done) { tableData = msg.done; dBtn.classList.remove('hidden'); continue; }
        tableData.push(msg.row);
        renderTable();
      }
    }
  }
});

function renderTable() {
  if (!tableData.length) return;
  const cols = Object.keys(tableData[0]);
  head.innerHTML = '<tr>' + cols.map(c => `<th class="px-4 py-2 text-left">${c}</th>`).join('') + '</tr>';
  body.innerHTML = tableData.map(row =>
    '<tr>' + cols.map(c => `<td class="px-4 py-2 border-t">${row[c] || ''}</td>`).join('') + '</tr>'
  ).join('');
}

// скачивание PDF таблицы
dBtn.addEventListener('click', async () => {
  const res = await fetch('/download_table_pdf', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({rows: tableData})
  });
  const blob = await res.blob();
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'algorithm.pdf';
  a.click();
  URL.revokeObjectURL(url);
});
</script>
</body>
</html>