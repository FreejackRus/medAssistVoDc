#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Конфигурационные константы и настройки для медицинского ассистента
"""

import re
from pathlib import Path

# ---------- OLLAMA SETTINGS ----------
OLLAMA_MODEL: str = "hf.co/unsloth/Qwen3-30B-A3B-Instruct-2507-GGUF:Q8_0"
OLLAMA_API_URL: str = "http://localhost:11434/api/chat"

# ---------- FILE PATHS ----------
SERVICES_FILE: Path = Path("docs/services.xlsx")

# ---------- TEXT PROCESSING ----------
CHUNK_SIZE: int = 2_000  # Увеличено для лучшего использования контекста модели
CHUNK_OVERLAP: int = 400  # Пропорционально увеличено для сохранения связности
MAX_INPUT_TOK: int = 260_000  # Оптимизировано под нативный контекст Qwen3 (262K токенов)

# ---------- REGEX PATTERNS ----------
# Улучшенные паттерны для распознавания структуры
SECTION_PATTERNS = [
    re.compile(r"^(\d+(?:\.\d+)*)\s+([^\n]+)", re.MULTILINE),  # 1.1, 2.3.4, … + title
    re.compile(r"^([IVX]+)\.\s+([^\n]+)", re.MULTILINE),       # I., II., III. + title
    re.compile(r"^(\d+)\.\s+([А-ЯЁ][^\n]+)", re.MULTILINE),   # 1. Заголовок
    re.compile(r"^([А-Я][а-я]+(?:\s+[а-я]+)*)\s*\n", re.MULTILINE),  # Заголовки с большой буквы
    # Более строгий паттерн для заглавных заголовков - только если это медицинские термины
    re.compile(r"^([А-ЯЁ]{2,}(?:\s+[А-ЯЁ]{2,})*)\s*\n(?=[А-ЯЁа-яё])", re.MULTILINE),  # ЗАГОЛОВКИ ЗАГЛАВНЫМИ
]

# Паттерны для извлечения названия диагноза
DIAGNOSIS_PATTERNS = [
    re.compile(r"(Сахарный диабет[^\n]*)", re.I),
    re.compile(r"(Гипертония[^\n]*)", re.I),
    re.compile(r"(Астма[^\n]*)", re.I),
    re.compile(r"(Артериальная гипертензия[^\n]*)", re.I),
    re.compile(r"(Ишемическая болезнь сердца[^\n]*)", re.I),
    re.compile(r"(Хроническая обструктивная болезнь легких[^\n]*)", re.I),
    re.compile(r"(Пневмония[^\n]*)", re.I),
    re.compile(r"(Инфаркт миокарда[^\n]*)", re.I),
    re.compile(r"(Клинические рекомендации[^\n]*)", re.I),
]

# Паттерны для поиска кода МКБ-10
MKB_PATTERNS = [
    re.compile(r'([A-Z]\d{2}(?:\.\d{1,2})?)', re.I),  # A00, B12.3, C45.1
    re.compile(r'МКБ[- ]?10?[:\s]*([A-Z]\d{2}(?:\.\d{1,2})?)', re.I),
    re.compile(r'код[:\s]*([A-Z]\d{2}(?:\.\d{1,2})?)', re.I),
]

# Паттерны для названия диагноза
DIAGNOSIS_NAME_PATTERNS = [
    # Клинические рекомендации по...
    re.compile(r'клинические\s+рекомендации\s+(?:по\s+)?(.+?)(?:\n|$)', re.I),
    # Протокол ведения больных...
    re.compile(r'протокол\s+ведения\s+больных\s+(.+?)(?:\n|$)', re.I),
    # Стандарт медицинской помощи...
    re.compile(r'стандарт\s+медицинской\s+помощи\s+(?:при\s+)?(.+?)(?:\n|$)', re.I),
    # Алгоритм диагностики и лечения...
    re.compile(r'алгоритм\s+(?:диагностики\s+и\s+)?лечения\s+(.+?)(?:\n|$)', re.I),
    # Методические рекомендации...
    re.compile(r'методические\s+рекомендации\s+(?:по\s+)?(.+?)(?:\n|$)', re.I),
    # Просто название болезни в начале документа
    re.compile(r'^([А-ЯЁ][а-яё\s]+(?:болезнь|синдром|заболевание|патология|недостаточность|гипертензия|диабет|астма|пневмония|инфаркт|стенокардия|аритмия|тахикардия|брадикардия)[а-яё\s]*)', re.M),
]

# ---------- MEDICAL KEYWORDS ----------
MEDICAL_KEYWORDS = [
    'определение', 'этиология', 'патогенез', 'классификация', 'диагностика', 
    'лечение', 'терапия', 'профилактика', 'прогноз', 'рекомендации',
    'показания', 'противопоказания', 'дозировка', 'мониторинг', 'осложнения'
]

# Ключевые слова для разделов
SECTION_KEYWORDS = [
    ("Определение", r"(определение|дефиниция)"),
    ("Этиология", r"(этиология|причины|факторы риска)"),
    ("Патогенез", r"(патогенез|механизм)"),
    ("Классификация", r"(классификация|типы|виды)"),
    ("Диагностика", r"(диагностика|диагноз|обследование)"),
    ("Лечение", r"(лечение|терапия|препараты)"),
    ("Профилактика", r"(профилактика|предупреждение)"),
    ("Прогноз", r"(прогноз|исход)"),
]

# ---------- SYSTEM PROMPTS ----------
SYSTEM_PROMPT = (
    "Ты — русскоязычный медицинский ассистент. "
    "ВАЖНО: Отвечай ТОЛЬКО на русском языке! "
    "Твой единственный источник информации — клинические рекомендации от пользователя. "
    "Включи ВСЕ данные: числа, единицы, препараты, дозы, критерии, сроки, исключения, нюансы. "
    "Для каждого пункта укажи точные числа, единицы, препараты, дозы, сроки, исключения. "
    "Если в рекомендациях явно написано «не применять» / «не делать» — включи это. "
    "Если в рекомендациях одно исследование исключает другое - включи это и распиши. Например, тест толерантности при сахарном диабете. "
    "Используй маркированные списки и подразделы. "
    "Все ответы формируются исключительно на основе текста клинических рекомендаций. "
    "Отвечай подробно c широкими объяснениями, метриками и по делу, структурируя текст по разделам: определение, диагностика, лечение, мониторинг, профилактика. "
    "Ответ должен быть без вводных и закрывающих комментариев от тебя. "
    "Весь ответ должен быть написан на русском языке!"
)

DIALOGUE_SYSTEM_PROMPT = (
    "ВАЖНО: ГЕНЕРИРУЙ ТЕКСТ ТОЛЬКО на русском языке! "
    "Ты — русскоязычный медицинский ассистент в диалоговом режиме. "
    "ВАЖНО: Отвечай ТОЛЬКО на русском языке! "
    "Твой единственный источник информации — клинические рекомендации от пользователя. "
    "Отвечай на вопросы пользователя, основываясь ТОЛЬКО на предоставленных клинических рекомендациях. "
    "Если информации нет в рекомендациях, честно скажи об этом. "
    "Будь точным, включай конкретные числа, дозы, препараты, сроки из документа. "
    "Поддерживай диалог, отвечай на уточняющие вопросы. "
    "Весь ответ должен быть написан на русском языке!"
)

# ---------- OLLAMA OPTIONS ----------
OLLAMA_OPTIONS = {
    "temperature": 0.05,  # Снижено для максимальной точности медицинских рекомендаций
    "top_p": 0.9,  # Слегка снижено для более детерминированных ответов
    "top_k": 40,  # Добавлено для ограничения выбора токенов
    "repeat_penalty": 1.1,  # Добавлено для избежания повторений
    "num_predict": -1,  # Без ограничений на длину ответа
    "stop": ["<|im_end|>", "</s>", "<|endoftext|>"],  # Расширенный список стоп-токенов
    "system": "Отвечай только на русском языке!"
}

DIALOGUE_OLLAMA_OPTIONS = {
    "temperature": 0.3,  # Снижено для более точных диалоговых ответов
    "top_p": 0.9,  # Оптимизировано для диалога
    "top_k": 50,  # Больше вариативности для диалога
    "repeat_penalty": 1.05,  # Меньше штрафа за повторения в диалоге
    "num_predict": -1,
    "stop": ["<|im_end|>", "</s>", "<|endoftext|>"],
    "system": "Отвечай только на русском языке!"
}

# ---------- LOGGING SETTINGS ----------
LOG_FORMAT = '%(asctime)s - %(levelname)s - %(message)s'
LOG_FILE = 'medical_assistant.log'